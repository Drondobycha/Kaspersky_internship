# Task Queue Service

**–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á —Å —Ñ–æ–Ω–æ–≤—ã–º–∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏ –Ω–∞ Go.**

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å
- –ü—É–ª—ã –≤–æ—Ä–∫–µ—Ä–æ–≤ —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –±—ç–∫–æ—Ñ—Ñ —Å –¥–∂–∏—Ç—Ç–µ—Ä–æ–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- Graceful shutdown —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á
- Healthcheck endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Go 1.24+
- Linux/macOS/Windows

### –°–±–æ—Ä–∫–∞

```bash
git clone <repository-url>
cd task-queue
go build -o bin/server cmd/server/main.go
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è           | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                          |
|----------------------|--------------|-----------------------------------|
| `SERVER_ADDR`        | `:8080`      | –ê–¥—Ä–µ—Å HTTP —Å–µ—Ä–≤–µ—Ä–∞                |
| `QUEUE_BUFFER_SIZE`  | `64`        | –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏              |
| `WORKERS_COUNT`      | `4`         | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Ä–∫–µ—Ä–æ–≤               |
| `MAX_RETRIES`        | `3`          | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤  |
| `BASE_DELAY_MS`      | `100`        | –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ (–º—Å)     |
| `MAX_DELAY_MS`       | `5000`       | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ (–º—Å)|
| `LOG_LEVEL`          | `info`       | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è              |

### –ü—Ä–∏–º–µ—Ä `.env` —Ñ–∞–π–ª–∞

```env
SERVER_ADDR=:8080
QUEUE_BUFFER_SIZE=64
WORKERS_COUNT=4
MAX_RETRIES=5
BASE_DELAY_MS=100
MAX_DELAY_MS=5000
LOG_LEVEL=info
```

---

## üöÄ –ó–∞–ø—É—Å–∫

### –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫

```bash
#–∑–∞–ø—É—Å–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
go run cmd/main.go --filename="config.env"
```


## üì° API Endpoints

### `POST /enqueue`

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å.

**Request:**

```json
{
  "id": "string",
  "payload": "string",
  "max_retries": 3
}
```

**Response:**

- `202 Accepted` ‚Äî –∑–∞–¥–∞—á–∞ –ø—Ä–∏–Ω—è—Ç–∞
- `400 Bad Request` ‚Äî –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
- `503 Service Unavailable` ‚Äî –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl -X POST http://localhost:8080/enqueue \
  -H "Content-Type: application/json" \
  -d '{"id":"task1","payload":"{\"action\":\"process\"}","max_retries":3}'
```

### `GET /healthz`

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞.

**Response:**

```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00Z",
  "queue": {
    "queueLength": 5,
    "activeWorkers": 10,
    "bufferCapacity": 100
  },
  "version": "1.0.0"
}
```

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl http://localhost:8080/healthz
```

---

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
HTTP Server ‚Üí Buffered Channel ‚Üí Worker Pool ‚Üí Task Processing
```

- **HTTP Server** ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ REST API
- **Buffered Channel** ‚Äî –±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á
- **Worker Pool** ‚Äî –ø—É–ª –≥–æ—Ä—É—Ç–∏–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
- **Task Processor** ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∑–∞–¥–∞—á

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á

```go
// –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∑–∞–¥–∞—á–∏
func TaskHandler(ctx context.Context, task *queue.Task) error {
    // –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç—ã (100-500ms)
    processingTime := time.Duration(100+rand.Intn(400)) * time.Millisecond

    select {
    case <-time.After(processingTime):
        // 20% chance of failure –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤
        if rand.Float32() < 0.2 {
            return fmt.Errorf("simulated processing error")
        }
        return nil
    case <-ctx.Done():
        return ctx.Err()
    }
}
```

---

## ‚ö° –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –±—ç–∫–æ—Ñ—Ñ

–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏:

```
–ü–æ–ø—ã—Ç–∫–∞ 1: 100ms ¬± jitter
–ü–æ–ø—ã—Ç–∫–∞ 2: 200ms ¬± jitter
–ü–æ–ø—ã—Ç–∫–∞ 3: 400ms ¬± jitter
...
```

Jitter –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤.

---

## üõ°Ô∏è Graceful Shutdown

–°–µ—Ä–≤–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:

- `SIGINT/SIGTERM` ‚Äî –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–µ–º –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º 30 —Å–µ–∫—É–Ω–¥
- –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–æ—Ä–∫–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

```bash
# –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
Ctrl+C
# –∏–ª–∏
kill -TERM <pid>
```

---
### –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

```bash
# –í–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
curl -X POST http://localhost:8080/enqueue \
  -d '{"id":"test1","payload":"{\"action\":\"process\"}","max_retries":3}'

# –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π payload
curl -X POST http://localhost:8080/enqueue \
  -d '{"id":"test2","payload":"simple string","max_retries":2}'

# –ü—Ä–æ–ø—É—â–µ–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
curl -X POST http://localhost:8080/enqueue \
  -d '{"payload":"test","max_retries":1}'
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Healthcheck metrics

```json
{
  "queueLength": 5,          // –¢–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–∏
  "activeWorkers": 10,       // –ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã
  "bufferCapacity": 100      // –ï–º–∫–æ—Å—Ç—å –±—É—Ñ–µ—Ä–∞
}
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–µ—Ä–≤–µ—Ä –ª–æ–≥–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è:

- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—å
- –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏
- –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- Graceful shutdown

---

## üêõ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

| –ü—Ä–æ–±–ª–µ–º–∞                     | –†–µ—à–µ–Ω–∏–µ                                                                 |
|------------------------------|-------------------------------------------------------------------------|
| –û—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞          | –£–≤–µ–ª–∏—á—å—Ç–µ `QUEUE_BUFFER_SIZE` –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É                   |
| –ó–∞–¥–∞—á–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è     | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `activeWorkers > 0` —á–µ—Ä–µ–∑ `/healthz`                        |
| –í—ã—Å–æ–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏   | –£–≤–µ–ª–∏—á—å—Ç–µ `WORKERS_COUNT` –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ `BASE_DELAY_MS/MAX_DELAY_MS`   |

---